[DEFAULT]
plugin_id = 9802

[config]
type=detector
enable=yes
source=log
location=/var/log/aws-console.log
create_file=true
process=
start=no
stop=no

[0001 - Create Role assignment]
event_type = event
precheck = "Create role assignment"
regexp = "\S+ - (?P<received_date>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}).*"caller":\s"(?P<user>\S+)".*"client_ip_address":\s"(?P<client_ip>\S+)".*"level":\s"(?P<log_level>\S+)".*"operation_name":\s\{"\S+\s"(?P<operation_name>[A-Za-z0-9.\/]+)", "localized_value":\s"(?P<event_name>Create role assignment)".*"status":\s\{"value":\s"(?P<status>Succeeded)".*"event_timestamp":\s"(?P<event_timestamp>\S+)".*"subscription_id":\s"(?P<subscription_id>\S+)".*"tenant_id":\s"(?P<tenant_id>\S+)""
plugin_sid = 1
date = {normalize_date($received_date)}
device = {resolve_ip($client_ip)}
username = {$user}
src_ip = {$client_ip}
dst_ip = NA
src_port = NA
dst_port = NA
protocol = NA
userdata1 = log level = {$log_level}
userdata2 = Operation name = {$operation_name}
userdata3 = Event name = {$event_name}
userdata4 = Event time = {$event_timestamp}
userdata5 = Subscription id = {$subscription_id}
userdata6 = Tenant id = {$tenant_id}
userdata7 = Status = {$status}


[0002 - Deallocate virtual machine]
event_type = event
precheck = "Deallocate Virtual Machine"
regexp = "\S+ - (?P<received_date>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})(.*"ipaddr":\s"(?P<ipaddr>\S+)")?.*"caller":\s"(?P<user>\S+)"(.*"client_ip_address":\s"(?P<client_ip>\S+)")?.*"level":\s"(?P<log_level>\S+)".*"operation_name":\s\{"\S+\s"(?P<operation_name>[A-Za-z0-9.\/]+)", "localized_value":\s"(?P<event_name>Deallocate Virtual Machine)".*"status":\s\{"value":\s"(?P<status>Succeeded)".*"event_timestamp":\s"(?P<event_timestamp>\S+)".*"subscription_id":\s"(?P<subscription_id>\S+)".*"tenant_id":\s"(?P<tenant_id>\S+)""
plugin_sid = 2
date = {normalize_date($received_date)}
device = {resolve_ip($client_ip)}
username = {$user}
src_ip = {$client_ip}
dst_ip = NA
src_port = NA
dst_port = NA
protocol = NA
userdata1 = log level = {$log_level}
userdata2 = Operation name = {$operation_name}
userdata3 = Event name = {$event_name}
userdata4 = Event time = {$event_timestamp}
userdata5 = Subscription id = {$subscription_id}
userdata6 = Tenant id = {$tenant_id}
userdata7 = Status = {$status}


[9999 - IAM generic]
event_type = event
regexp = "(?P<syslog_date>\S{3}\s+\d{1,2}\s+\d{2}:\d{2}:\d{2}).*type":"(?P<user_type>IAMUser)"(.*"userName":"(?P<user>[\w-]+)"})?.*eventTime":"(?P<event_time>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z)","eventSource":"(?P<service>[a-z0-9.]+)","eventName":"(?P<event_name>.*)","awsRegion":"(?P<region>\S+)","sourceIPAddress":"(?P<source_ip>(\d{1,3}.\d{1,3}.\d{1,3}.\d{1,3})?|([a-z0-9.]+)?)",".*eventType":"(?P<event_type>\w+)"(.*"ip_city":"(?P<location>\w+)")?.*"
plugin_sid = 20000
date = {normalize_date($syslog_date)}
device = {resolve_ip($source_ip)}
username = {$user}
src_ip = {$source_ip}
dst_ip = NA
src_port = NA
dst_port = NA
protocol = NA
userdata1 = user type = {$user_type}
userdata2 = event time = {$event_time}
userdata3 = AWS service = {$service}
userdata4 = event name = {$event_name}
userdata5 = aws region = {$region}
userdata6 = event type = {$event_type}
userdata7 = ip location = {$location}
